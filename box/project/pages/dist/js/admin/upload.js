angular.module("MetronicApp").directive("myUpload",["FileUploader","$timeout",function(FileUploader,$timeout){var helper={getType:function(name){return"|"+name.slice(name.lastIndexOf(".")+1)+"|"},isImage:function(type,closeMsg){return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(type.toLowerCase())||(closeMsg?void 0:(sweetAlert("警告","请确定文件格式为|jpg|png|jpeg|bmp|gif|","error"),!1))},isDoc:function(type,closeMsg){return-1!=="|doc|docx|txt|".indexOf(type.toLowerCase())||(closeMsg?void 0:(sweetAlert("警告","请确定文件格式为|doc|docx|txt|","error"),!1))},isVideo:function(type,closeMsg){return-1!=="|rm|rmvb|avi|mp4|3gp|".indexOf(type.toLowerCase())||(closeMsg?void 0:(sweetAlert("警告","请确定文件格式为|rm|rmvb|avi|mp4|3gp|","error"),!1))},isMp3:function(type,closeMsg){return-1!=="|mp3|".indexOf(type.toLowerCase())||(closeMsg?void 0:(sweetAlert("警告","请确定文件格式为|mp3|","error"),!1))},isZip:function(type,closeMsg){return-1!=="|zip|rar|".indexOf(type.toLowerCase())||(closeMsg?void 0:(sweetAlert("警告","请确定文件格式为|zip|rar|","error"),!1))},uploadImgCheckedPx:function(f,w,h,msg,callback){if(w&&h){var reader=new FileReader;reader.onload=function(e){var data=e.target.result,image=new Image;image.onload=function(){var width=image.width,height=image.height;width>w||height>h?callback&&callback(!1):callback&&callback(!0)},image.src=data},f&&reader.readAsDataURL(f)}else callback&&callback(!0)}};return{restrict:"E",replace:!0,scope:!1,template:'<input class="fileUpLoad" type="file" nv-file-select="" uploader="uploader" filters="{{filters}}"/>',link:function(scope,element,attributes){$timeout(function(){element.bind("change",function(changeEvent){scope.$apply(function(){var fileList=changeEvent.target.files;angular.forEach(fileList,function(selectedFile,key){var type=helper.getType(selectedFile.name);helper.isImage(type,!0)&&helper.uploadImgCheckedPx(selectedFile,scope.width,scope.height,scope.msg,function(state){state||(sweetAlert("警告","所选图片尺寸不满足！","error"),scope.uploader.clearQueue(),scope.$apply())})})})})},0)},controller:function($scope){var uploader=$scope.uploader=new FileUploader({url:$scope.url,autoUpload:!1,removeAfterUpload:!0,queueLimit:$scope.queueLimit?$scope.queueLimit:10}),showMsg=function(itemSize,maxSize){return!(itemSize/1024>=maxSize)&&($scope.size=itemSize,!0)};uploader.filters.push({name:"imageFilter",fn:function(item,options){if(!showMsg(item.size,4096))return!1;var type=helper.getType(item.name);return helper.isImage(type)&&this.queue.length<5}},{name:"docFilter",fn:function(item,options){if(!showMsg(item.size,3072))return!1;var type=helper.getType(item.name);return helper.isDoc(type)}},{name:"videoFilter",fn:function(item,options){if(!showMsg(item.size,204800))return!1;var type=helper.getType(item.name);return helper.isVideo(type)}},{name:"mp3Filter",fn:function(item,options){if(!showMsg(item.size,20480))return!1;var type=helper.getType(item.name);return helper.isMp3(type)}},{name:"zipFilter",fn:function(item,options){if(!showMsg(item.size,20480))return!1;var type=helper.getType(item.name);return helper.isZip(type)}}),uploader.onWhenAddingFileFailed=function(item,filter,options){},uploader.onAfterAddingFile=function(fileItem){},uploader.onAfterAddingAll=function(addedFileItems){},uploader.onBeforeUploadItem=function(item){},uploader.onProgressItem=function(fileItem,progress){},uploader.onProgressAll=function(progress){},uploader.onSuccessItem=function(fileItem,response,status,headers){$scope.uploadDown={},"SUCCESS"==response.message&&($scope.uploadDown.url=response.url),"slideShow"===$scope.changeStatusType&&null!=$scope.changeSlideShow&&$scope.changeSlideShow(),"slide"==$scope.controllerName&&null!=$scope.save&&$scope.save(),$scope.clearQueue()},uploader.onErrorItem=function(fileItem,response,status,headers){},uploader.onCancelItem=function(fileItem,response,status,headers){},uploader.onCompleteItem=function(fileItem,response,status,headers){},uploader.onCompleteAll=function(fileItem,response,status,headers){}}}}]);