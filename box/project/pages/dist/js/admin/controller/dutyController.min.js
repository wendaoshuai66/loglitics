function dutyController(e,t,o,a,r,l){e.data={},e.searchObj={ifLogistics:1,getDutyInfo:!0,status:1},e.controllerName="duty",e.data.maintenanceItems=[],e.columns=[{data:"id"},{data:"name"},{data:"campus.name"},{data:"parent.name"},{data:"description"},{data:"typeList"},{data:"dateStr"},{data:"addDateTime"}],e.orderableAry=[0,3],e.htmlType=[4],e.wrapAry=[2],e.wrapLongAry=[1,3],e.targetsOpt=8,e.order=[[7,"desc"]],e.optHtmlAry=["duty","dutyShow"];var c="getDepartmentList";e.url=c,e.reloadUrl=c,e.initDataTablesName="dutyDataTable",dataTables.init(e,t,o,a,r),e.dutySite=function(e,t,o){localStorage.setItem("com.logistics.duty.departmentSelectedName",t),localStorage.setItem("com.logistics.duty.departmentSelectedId",e),localStorage.setItem("com.logistics.duty.departmentSelectedCampusName",o),l.go("dutyRegister",{id:e})},e.dutyShowView=function(e,t){localStorage.setItem("com.logistics.duty.dutyShowDepartmentId",e),localStorage.setItem("com.logistics.duty.dutyShowDepartmentName",t),l.go("dutyShow",{id:e})},e.dutyList=function(e,t){localStorage.setItem("com.logistics.duty.departmentSelectedId",e),localStorage.setItem("com.logistics.duty.dutyShowDepartmentName",t),l.go("dutyList",{id:e})}}function dutyRegisterController(e,t,o,a,r,l,c){var n=localStorage.getItem("com.logistics.duty.departmentSelectedName"),s=localStorage.getItem("com.logistics.duty.departmentSelectedCampusName");e.dutyDepartmentName=n,e.campusName=s;var i=localStorage.getItem("com.logistics.duty.registerStep"),u=localStorage.getItem("com.logistics.duty.registerDone");null!=i&&"null"!=i&&(i<<=0),null!=u&&"null"!=u&&(u<<=0),e.registerStep=i||1,e.registerDone=u||1,e.nextCheckDown=!1,e.previous=function(){e.registerStep>1&&(e.registerStep=e.registerStep-1),$("#previousStep").blur()},e.nextStep=function(){e.registerStep<6&&(e.registerStep=e.registerStep+1,e.registerDone<e.registerStep&&(e.registerDone=e.registerDone+1)),$("#nextStep").blur()},e.closeRegister=function(){for(var e in localStorage)e.startsWith("com.logistics.duty")&&localStorage.removeItem(e);l.go("duty")},e.$watch("registerStep",function(t,o){if(localStorage.setItem("com.logistics.duty.registerStep",t),localStorage.setItem("com.logistics.duty.registerDone",e.registerDone),t!==o&&1===o){var a=e.getScope("dutyRegisterOneStep").checkedDayList;if(null!=a&&a.length>0){var r=a.join(",");localStorage.setItem("com.logistics.duty.checkedDateList",r),localStorage.setItem("com.logistics.duty.checkedYearMonth",a[0].substring(0,7))}}if(t!==o&&2===o){var l=e.getScope("dutyRegisterTwoStep"),n=l.typeSelectData,s=l.maintenanceTypeSelectData;angular.forEach(s,function(e){e.id==n&&localStorage.setItem("com.logistics.duty.typeSelectedName",e.name)}),localStorage.setItem("com.logistics.duty.typeSelectedId",n);var i=l.maintenanceItems[n];localStorage.setItem("com.logistics.duty.checkedTypeWorker"+n,(null!=i?i:"null").toString())}if(t!==o&&4===o){var u=e.getScope("dutyRegisterFourStep").events;localStorage.setItem("com.logistics.duty.lastEvents",JSON.stringify(u))}if(6===t&&5===o){e.addLoading();var d=e.getScope("dutyRegisterFiveStep"),g=localStorage.getItem("com.logistics.duty.typeSelectedId"),p=localStorage.getItem("com.logistics.duty.departmentSelectedId"),y=d.tableListData,m=JSON.stringify(y);localStorage.setItem("com.logistics.duty.savedDutyList",m),e.url="saveDuty",e.params={typeId:g,departmentId:p,tableListData:m},e.optName="生成值班记录",c.all([e.postApiNoReload(e)]).then(function(){var t=e.getScope("dutyRegisterSixStep");t.getTableDateInfo(t)},function(){e.registerStep=o,localStorage.setItem("com.logistics.duty.registerStep",o)})}1===t&&o!==t&&localStorage.setItem("com.logistics.duty.callbackToFirst","true")}),e.getRegisterLineClass=function(e){return"(registerStep=="+e+"&&registerDone>"+e+")?'error':(registerStep=="+e+"?'error':(registerDone>="+e+"?'done':'info'))"}}function dutyRegisterOneStepController(e,t,o,a,r,l){e.stepOne="hello",e.holidayDate=[],e.controllerName="dutyRegisterOneStep";var c=new Date;e.url="getInitCalendarHolidayFromDate",e.year=c.getFullYear(),e.month=c.getMonth(),calendar.registerInitMonth(e),e.$watch("checkedDayList",function(){localStorage.setItem("com.logistics.duty.autoDuty.dirtyDataDuty",!0)})}function dutyRegisterTwoStepController($scope,$http,$compile,$location,$filter,$state,$q,$timeout){$scope.addLoading(),$scope.selectedTypeInfo=[],$scope.allTypeHasOwnWorkerFlag=!1,$scope.maintenanceItems={},$q.all([getMaintenanceTypeSelectData($scope,$http,$compile,$location,$filter)]).then(function(){return getWorkerSelectData($scope,$http,$compile,$location,$filter)}).then(function(){var e=localStorage.getItem("com.logistics.duty.typeSelectedId");null!=e&&"null"!=e&&($scope.typeSelectData=e<<0,$timeout(function(){$("#selectOne").triggerHandler("change"),$scope.typeSelectChange()},0)),$scope.checkoutSelectInfo(),$scope.removeLoading()}),$scope.typeSelectChange=function(){var e=$scope.typeSelectData;$scope.typeIsValid=!!e,localStorage.setItem("com.logistics.duty.typeSelectedId",e),angular.forEach($scope.maintenanceTypeSelectData,function(t){t.id===e&&($scope.selectedTypeInfo.splice(0),$scope.selectedTypeInfo.push(t))}),$scope.checkAllTypeHasOwnWorker()},$scope.checkoutSelectInfo=function(){var allTypeData=$scope.maintenanceTypeSelectData;$scope.getWorkerListFromDepartment(),angular.forEach(allTypeData,function(val){var typeWorkerList=localStorage.getItem("com.logistics.duty.checkedTypeWorker"+val.id);$scope.getWorkerListFromType(val.id),null!=typeWorkerList&&"null"!=typeWorkerList&&($scope.maintenanceItems[val.id]=eval("["+typeWorkerList+"]"))}),$scope.checkAllTypeHasOwnWorker()},$scope.getWorkerListFromDepartment=function(){var e=localStorage.getItem("com.logistics.duty.departmentSelectedId"),t=[];$scope.workerSelectData.map(function(o){null!=e&&o.maintenanceWorker.department.id==e&&t.push(o)}),$scope.workerAllList=t},$scope.getWorkerListFromType=function(e){var t=[];angular.forEach($scope.workerAllList,function(o){o.maintenanceWorker.maintenanceType.id==e&&t.push(o)}),$scope["workerFromType"+e]=t},$scope.checkAllTypeHasOwnWorker=function(){var allType=$scope.selectedTypeInfo,tempLength=0;angular.forEach(allType,function(e){var t=$scope.maintenanceItems[e.id];null!=t&&t.length>0&&tempLength++});var typeSelect=$scope.typeSelectData,dutyRegisterScope=$scope.getScope("dutyRegister");typeSelect&&tempLength>0?($scope.allTypeHasOwnWorkerFlag=!0,dutyRegisterScope.nextCheckDown=!0):($scope.allTypeHasOwnWorkerFlag=!1,dutyRegisterScope.nextCheckDown=!1);var typeId=$scope.typeSelectData,savedWorkerObjList=eval("["+localStorage.getItem("com.logistics.duty.checkedTypeWorker"+typeId)+"]"),savedWorkers=null==savedWorkerObjList?null:savedWorkerObjList.toString(),nowWorkerObjList=$scope.maintenanceItems[typeId],nowWorkers=null==nowWorkerObjList?null:nowWorkerObjList.toString();savedWorkers!==nowWorkers&&localStorage.setItem("com.logistics.duty.autoDuty.dirtyDataDuty",!0)},$scope.$watch("typeSelectData",function(e,t){e!==t&&null!=t&&localStorage.setItem("com.logistics.duty.autoDuty.dirtyDataDuty",!0)})}function dutyRegisterThreeStepController($scope,$http,$compile,$location,$filter,$state,$q,$timeout){$scope.cleanEvents=function(){localStorage.removeItem("com.logistics.duty.autoDutyEvents"),localStorage.removeItem("com.logistics.duty.autoDuty.dayDutyPersonId"),localStorage.removeItem("com.logistics.duty.autoDuty.nightDutyPersonId"),localStorage.removeItem("com.logistics.duty.autoDuty.dirtyDataDuty"),sweetAlert({title:"您修改了值班日期或人员",text:"请重新生成值班表",type:"warning",timer:2e3,showConfirmButton:!1})};var dutyRegisterScope=$scope.getScope("dutyRegister");"true"==localStorage.getItem("com.logistics.duty.autoDuty.dirtyDataDuty")&&$scope.cleanEvents(),$scope.autoDutyDown=!1,dutyRegisterScope.nextCheckDown=!1,$scope.checkAllPersonSelectStr="dayDutyPersonId==null || nightDutyPersonId==null";var typeSelectedId=localStorage.getItem("com.logistics.duty.typeSelectedId"),personIds=eval("["+localStorage.getItem("com.logistics.duty.checkedTypeWorker"+typeSelectedId)+"]");$q.all([getWorkerSelectData($scope,$http,$compile,$location,$filter)]).then(function(){$scope.getPersonListFromIds(personIds)}),$scope.getPersonListFromIds=function(e){var t=$scope.workerSelectData,o=[];angular.forEach(t,function(t){$.inArray(t.id,e)>-1&&o.push(t)}),$scope.dutyPerson=o;var a=localStorage.getItem("com.logistics.duty.autoDutyEvents"),r=localStorage.getItem("com.logistics.duty.autoDuty.dayDutyPersonId"),l=localStorage.getItem("com.logistics.duty.autoDuty.nightDutyPersonId");null!=r&&($scope.dayDutyPersonId=r<<0),null!=l&&($scope.nightDutyPersonId=l<<0),angular.forEach(["selectDay","selectNight"],function(e){$timeout(function(){angular.element("[id="+e+"]").triggerHandler("change")},0)}),null!=a&&"null"!=a&&$scope.generateAutoDuty(JSON.parse(a))},$scope.controllerName="dutyRegisterThreeStep",calendar.autoGenerateDuty($scope),$scope.generateAutoDuty=function(e){if($scope.dayDutyPersonId&&$scope.nightDutyPersonId){$scope.addLoading();var t=$scope.getScope("dutyRegister");$scope.autoDutyDown=!1,t.nextCheckDown=!1;var o=$("#calendar");o.fullCalendar("destroy"),calendar.autoGenerateDuty($scope),$scope.getDayAndNightDutyListFromDate();var a=$scope.dayCalendarData.concat($scope.nightCalendarData);localStorage.setItem("com.logistics.duty.autoDutyEvents",JSON.stringify(a)),e?o.fullCalendar("addEventSource",e):(o.fullCalendar("addEventSource",a),localStorage.setItem("com.logistics.duty.autoDuty.dayDutyPersonId",$scope.dayDutyPersonId),localStorage.setItem("com.logistics.duty.autoDuty.nightDutyPersonId",$scope.nightDutyPersonId)),o.fullCalendar("removeEventSource"),$scope.removeLoading(),$scope.autoDutyDown=!0,t.nextCheckDown=!0}},$scope.getDayAndNightDutyListFromDate=function(){var e=localStorage.getItem("com.logistics.duty.checkedDateList"),t=null!=e?e.split(","):[],o=angular.copy($scope.dutyPerson),a=-1,r=-1;o.forEach(function(e,t){e.id==$scope.dayDutyPersonId&&(a=t),e.id==$scope.nightDutyPersonId&&(r=t)}),$scope.dayCalendarData=$scope.concatDutyList(t,o,a,!0),$scope.nightCalendarData=$scope.concatDutyList(t,o,r,!1)},$scope.concatDutyList=function(e,t,o,a){if(-1!=o){var r="Day";a||(r="Night");var l=angular.copy(t),c=l.splice(0,o),n=l.concat(c),s=n.length,i=0,u=[];return angular.forEach(e,function(e){var t={title:n[i].name,start:e,end:$scope.getNextDayStr(e),id:n[i].id+"#"+e+"#"+r,backgroundColor:a?"#eeeeee":"#333333",textColor:a?"#222222":"#ffffff"};u.push(t),i+1>=s?i=0:i++}),u}}}function dutyRegisterFourStepController(e,t,o,a,r,l,c,n){e.controllerName="dutyRegisterFourStep";var s=localStorage.getItem("com.logistics.duty.autoDutyEvents"),i=localStorage.getItem("com.logistics.duty.checkedDateList").split(",");e.checkedDateList=i,e.events=JSON.parse(s),calendar.manualGenerateDuty(e),e.select={},e.select.isSelected=!0,e.select.onText="自动调整",e.select.offText="手动调整",e.select.isActive=!0,e.select.size="normal",e.select.animate=!0,e.select.radioOff=!0,e.select.handleWidth="auto",e.select.labelWidth="auto",e.select.inverse=!0,e.select.onColor="info",e.select.offColor="danger",e.toggle=function(){e.select.isSelected=!e.select.isSelected}}function dutyRegisterFiveStepController(e,t,o,a,r,l,c,n){var s=localStorage.getItem("com.logistics.duty.lastEvents"),i=JSON.parse(s);e.events=i,e.getHolidayInfoFromDate=function(e){var t=JSON.parse(localStorage.getItem("com.logistics.duty.AllHolidayFromDate")),o={};return angular.forEach(t,function(t){t.start==e&&(o.type=t.type,o.name=null==t.title||""==t.title?null:t.title)}),o},e.checkoutTableUseInfo=function(){var t=[],o=[];angular.forEach(e.events,function(e){var a={};a.time=e.start,o.push(e.start);var r=e.id.split("#")[0];-1!=e.id.indexOf("Day")?(a.dayPersonName=e.title,a.dayId=r):(a.nightPersonName=e.title,a.nightId=r),t.push(a)});var a=[];o=e.uniqueList(o),angular.forEach(o,function(o){var r=e.getHolidayInfoFromDate(o),l={time:o+" ("+dateUtil.getWeekStr(o)+")",dayPersonName:[],nightPersonName:[],dayId:[],nightId:[],type:null==r?0:r.type,name:null==r?null:r.name};angular.forEach(t,function(e){o==e.time&&(e.dayPersonName&&(l.dayPersonName.push(e.dayPersonName),l.dayId.push(e.dayId)),e.nightPersonName&&(l.nightPersonName.push(e.nightPersonName),l.nightId.push(e.nightId)))}),a.push(l)}),e.tableListData=a},e.checkoutTableUseInfo(),calendar.showLastDuty(e);var u=localStorage.getItem("com.logistics.duty.checkedYearMonth"),d=localStorage.getItem("com.logistics.duty.typeSelectedName"),g=localStorage.getItem("com.logistics.duty.departmentSelectedName");e.dutyYear=u.split("-")[0],e.dutyMonth=u.split("-")[1],e.dutyTypeName=d,e.dutyDepartmentName=g}function dutyRegisterSixStepController(e,t,o,a,r,l,c,n){e.getTableDateInfo=function(e){var t=localStorage.getItem("com.logistics.duty.checkedYearMonth"),o=localStorage.getItem("com.logistics.duty.typeSelectedName"),a=localStorage.getItem("com.logistics.duty.departmentSelectedName");e.dutyYear=t.split("-")[0],e.dutyMonth=t.split("-")[1],e.dutyTypeName=o,e.dutyDepartmentName=a,e.date=e.dutyYear+"-"+e.dutyMonth,e.departmentId=localStorage.getItem("com.logistics.duty.departmentSelectedId")<<0,e.typeId=localStorage.getItem("com.logistics.duty.typeSelectedId")<<0,e.getDutyInfo(e)},e.saveDutyImg=function(){var t=$("#dutyTable");html2canvas(t,{onrendered:function(t){t.setAttribute("id","thecanvas"),document.getElementById("canvasImg").appendChild(t);var o=document.getElementById("thecanvas"),a=Canvas2Image.saveAsPNG(o,!0).getAttribute("src");e.saveImage(a,e.dutyDepartmentName+" , "+e.dutyTypeName+" , "+e.dutyYear+" 年 "+e.dutyMonth+" 月 值班表",o)}})},e.printDutyTable=function(){$("#dutyTable").print()}}function dutyShowListController(e,t,o,a,r,l,c,n){var s=localStorage.getItem("com.logistics.duty.dutyShowDepartmentId"),i=localStorage.getItem("com.logistics.duty.dutyShowDepartmentName");e.departmentName=i,e.maintenanceItems={},e.checkedTypeAndDate=!1,c.all([getMaintenanceTypeSelectData(e,t,o,a,r)]),e.option={format:"yyyy-mm",weekStart:1,autoclose:!0,startView:3,minView:3,forceParse:!1},e.getTypeNameFromId=function(t){var o=e.maintenanceTypeSelectData;angular.forEach(o,function(o){o.id==t&&(e.typeName=o.name,e.typeId=o.id)})},datePickers.init(e,t,o,a,r),$("table tfoot .today").html("本月"),e.checkedChange=function(){delete e.tableListData,e.getTypeNameFromId(e.typeSelectData),e.dutyYearMonth&&(e.dutyYear=e.dutyYearMonth.substring(0,4),e.dutyMonth=e.dutyYearMonth.substring(5,7)),e.typeSelectData&&e.dutyYearMonth&&(e.checkedTypeAndDate=!0,e.addLoading(),e.departmentId=s<<0,e.typeId=e.typeId<<0,e.date=e.dutyYear+"-"+e.dutyMonth,e.getDutyInfo(e))},e.addDuty=function(){localStorage.setItem("com.logistics.duty.checkedYearMonth",e.dutyYearMonth),localStorage.setItem("com.logistics.duty.departmentSelectedId",s),localStorage.setItem("com.logistics.duty.typeSelectedId",e.typeId),localStorage.setItem("com.logistics.duty.callbackToFirst",!0),l.go("dutyRegister")},e.saveDutyImg=function(){var t=$("#dutyTable");html2canvas(t,{onrendered:function(t){t.setAttribute("id","thecanvas"),document.getElementById("canvasImg").appendChild(t);var o=document.getElementById("thecanvas"),a=Canvas2Image.saveAsPNG(o,!0).getAttribute("src");e.saveImage(a,e.departmentName+" , "+e.typeName+" , "+e.dutyYear+" 年 "+e.dutyMonth+" 月 值班表",o)}})},e.printDutyTable=function(){$("#dutyTable").print()}}function dutyDetailController(e,t,o,a,r,l,c,n){var s=localStorage.getItem("com.logistics.duty.dutyShowDepartmentId"),i=localStorage.getItem("com.logistics.duty.dutyShowDepartmentName");e.departmentName=i,e.selectUrl="getDutiesDetailFromDepartmentId",e.selectParams={departmentId:s},e.selectPara="dutyInfo",e.selectOptName="获取"+i+"值班配置",c.all([e.getSelectInfoApi(e)]).then(function(){null==e.dutyInfo||0===e.dutyInfo.length?e.noData=!0:e.noData=!1})}angular.module("MetronicApp").controller("dutyController",["$scope","$http","$compile","$location","$filter","$state",dutyController]),angular.module("MetronicApp").controller("dutyRegisterController",["$scope","$http","$compile","$location","$filter","$state","$q",dutyRegisterController]),angular.module("MetronicApp").controller("dutyRegisterOneStepController",["$scope","$http","$compile","$location","$filter","$state",dutyRegisterOneStepController]),angular.module("MetronicApp").controller("dutyRegisterTwoStepController",["$scope","$http","$compile","$location","$filter","$state","$q","$timeout",dutyRegisterTwoStepController]),angular.module("MetronicApp").controller("dutyRegisterThreeStepController",["$scope","$http","$compile","$location","$filter","$state","$q","$timeout",dutyRegisterThreeStepController]),angular.module("MetronicApp").controller("dutyRegisterFourStepController",["$scope","$http","$compile","$location","$filter","$state","$q","$timeout",dutyRegisterFourStepController]),angular.module("MetronicApp").controller("dutyRegisterFiveStepController",["$scope","$http","$compile","$location","$filter","$state","$q","$timeout",dutyRegisterFiveStepController]),angular.module("MetronicApp").controller("dutyRegisterSixStepController",["$scope","$http","$compile","$location","$filter","$state","$q","$timeout",dutyRegisterSixStepController]),angular.module("MetronicApp").controller("dutyShowListController",["$scope","$http","$compile","$location","$filter","$state","$q","$timeout",dutyShowListController]),angular.module("MetronicApp").controller("dutyDetailController",["$scope","$http","$compile","$location","$filter","$state","$q","$timeout",dutyDetailController]);